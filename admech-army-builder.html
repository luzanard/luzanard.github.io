<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ADEPTUS MECHANICUS — Army Builder 10th Edition</title>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Share+Tech+Mono&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
<style>
:root {
  --cog-gold: #c8a84b;
  --cog-gold-dark: #8a6e2a;
  --cog-red: #8b1a1a;
  --cog-red-bright: #c0392b;
  --steel: #2a3040;
  --steel-light: #3a4255;
  --steel-dark: #15191f;
  --panel: #1c2130;
  --border: #c8a84b44;
  --text: #d4c8a8;
  --text-dim: #7a8099;
  --text-bright: #f0e8c8;
  --machine-green: #3aff8a;
  --machine-green-dim: #1a5a3a;
  --accent-blue: #4a8fff;
  --font-head: 'Orbitron', monospace;
  --font-body: 'Rajdhani', sans-serif;
  --font-mono: 'Share Tech Mono', monospace;
}

* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  background: var(--steel-dark);
  color: var(--text);
  font-family: var(--font-body);
  font-size: 15px;
  min-height: 100vh;
  overflow-x: hidden;
}

/* Background texture */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background:
    repeating-linear-gradient(0deg, transparent, transparent 40px, rgba(200,168,75,0.03) 40px, rgba(200,168,75,0.03) 41px),
    repeating-linear-gradient(90deg, transparent, transparent 40px, rgba(200,168,75,0.03) 40px, rgba(200,168,75,0.03) 41px);
  pointer-events: none;
  z-index: 0;
}

/* ===== HEADER ===== */
.header {
  background: linear-gradient(180deg, #0a0c10 0%, var(--steel-dark) 100%);
  border-bottom: 2px solid var(--cog-gold);
  padding: 0;
  position: relative;
  z-index: 10;
}
.header-inner {
  display: flex;
  align-items: stretch;
  max-width: 1400px;
  margin: 0 auto;
  padding: 0 20px;
}
.header-cog {
  font-size: 60px;
  line-height: 1;
  padding: 16px 24px 16px 0;
  color: var(--cog-gold);
  text-shadow: 0 0 20px rgba(200,168,75,0.5);
  animation: cogSpin 20s linear infinite;
  display: flex; align-items: center;
}
@keyframes cogSpin {
  from { text-shadow: 0 0 20px rgba(200,168,75,0.5), 0 0 40px rgba(200,168,75,0.2); }
  50% { text-shadow: 0 0 30px rgba(200,168,75,0.8), 0 0 60px rgba(200,168,75,0.4); }
  to { text-shadow: 0 0 20px rgba(200,168,75,0.5), 0 0 40px rgba(200,168,75,0.2); }
}
.header-text { flex: 1; padding: 14px 0; }
.header-subtitle { font-family: var(--font-mono); font-size: 11px; color: var(--text-dim); letter-spacing: 3px; text-transform: uppercase; }
.header-title { font-family: var(--font-head); font-size: 26px; font-weight: 900; color: var(--cog-gold); letter-spacing: 2px; line-height: 1; margin: 2px 0; text-transform: uppercase; }
.header-faction { font-family: var(--font-body); font-size: 13px; color: var(--text-dim); letter-spacing: 5px; text-transform: uppercase; }
.header-points {
  display: flex; flex-direction: column; justify-content: center; align-items: flex-end;
  padding: 14px 0;
  border-left: 1px solid var(--border);
  padding-left: 20px;
  min-width: 160px;
}
.pts-label { font-family: var(--font-mono); font-size: 10px; color: var(--text-dim); letter-spacing: 2px; }
.pts-value { font-family: var(--font-head); font-size: 36px; font-weight: 700; color: var(--machine-green); line-height: 1; }
.pts-limit { font-family: var(--font-mono); font-size: 11px; color: var(--text-dim); }

/* ===== MAIN LAYOUT ===== */
.main { max-width: 1400px; margin: 0 auto; padding: 20px; display: grid; grid-template-columns: 320px 1fr; gap: 20px; position: relative; z-index: 1; }

/* ===== PANELS ===== */
.panel {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 2px;
  position: relative;
  overflow: hidden;
}
.panel::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 2px;
  background: linear-gradient(90deg, transparent, var(--cog-gold), transparent);
}
.panel-header {
  padding: 10px 14px;
  background: rgba(200,168,75,0.08);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 8px;
}
.panel-header-icon { color: var(--cog-gold); font-size: 14px; }
.panel-header-title { font-family: var(--font-head); font-size: 11px; font-weight: 700; color: var(--cog-gold); letter-spacing: 2px; text-transform: uppercase; }
.panel-body { padding: 12px; }

/* ===== DETACHMENT SELECTOR ===== */
.det-list { display: flex; flex-direction: column; gap: 6px; }
.det-btn {
  background: rgba(255,255,255,0.03);
  border: 1px solid var(--border);
  border-radius: 2px;
  padding: 10px 12px;
  cursor: pointer;
  text-align: left;
  transition: all 0.15s;
  position: relative;
  overflow: hidden;
}
.det-btn::before {
  content: '';
  position: absolute;
  left: 0; top: 0; bottom: 0;
  width: 3px;
  background: var(--cog-gold);
  opacity: 0;
  transition: opacity 0.15s;
}
.det-btn:hover { background: rgba(200,168,75,0.08); border-color: var(--cog-gold-dark); }
.det-btn.active { background: rgba(200,168,75,0.1); border-color: var(--cog-gold); }
.det-btn.active::before { opacity: 1; }
.det-name { font-family: var(--font-head); font-size: 10px; font-weight: 700; color: var(--cog-gold); letter-spacing: 1px; text-transform: uppercase; }
.det-desc { font-size: 11px; color: var(--text-dim); margin-top: 2px; line-height: 1.3; }

/* ===== DETACHMENT RULE DISPLAY ===== */
.det-rule-box {
  background: rgba(200,168,75,0.05);
  border: 1px solid var(--cog-gold-dark);
  border-radius: 2px;
  padding: 10px;
  margin-top: 10px;
}
.det-rule-label { font-family: var(--font-mono); font-size: 9px; color: var(--cog-gold); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 4px; }
.det-rule-title { font-family: var(--font-head); font-size: 12px; font-weight: 700; color: var(--text-bright); margin-bottom: 4px; }
.det-rule-text { font-size: 11px; color: var(--text-dim); line-height: 1.5; }

/* ===== ARMY RULE ===== */
.army-rule {
  background: linear-gradient(135deg, rgba(200,168,75,0.08), rgba(200,168,75,0.03));
  border: 1px solid var(--cog-gold-dark);
  border-radius: 2px;
  padding: 12px;
  margin-bottom: 16px;
}
.army-rule-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
.army-rule-icon { color: var(--cog-gold); font-size: 18px; }
.army-rule-title { font-family: var(--font-head); font-size: 12px; font-weight: 700; color: var(--cog-gold); letter-spacing: 1px; }
.imperative-tabs { display: flex; gap: 4px; margin-bottom: 8px; }
.imp-tab {
  flex: 1; padding: 5px 8px;
  background: rgba(255,255,255,0.03); border: 1px solid var(--border);
  border-radius: 2px; cursor: pointer;
  font-family: var(--font-head); font-size: 9px; font-weight: 700; color: var(--text-dim);
  letter-spacing: 1px; text-transform: uppercase; text-align: center;
  transition: all 0.15s;
}
.imp-tab.active-pro { background: rgba(74,143,255,0.15); border-color: var(--accent-blue); color: var(--accent-blue); }
.imp-tab.active-con { background: rgba(192,57,43,0.15); border-color: var(--cog-red-bright); color: var(--cog-red-bright); }
.imperative-content { font-size: 11px; color: var(--text-dim); line-height: 1.6; }
.imperative-content ul { padding-left: 14px; }
.imperative-content li { margin-bottom: 2px; }

/* ===== UNIT ROSTER (right column) ===== */
.roster-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 14px;
}
.roster-title { font-family: var(--font-head); font-size: 14px; font-weight: 700; color: var(--text-bright); letter-spacing: 2px; text-transform: uppercase; }
.btn-add-unit {
  background: linear-gradient(135deg, var(--cog-red) 0%, #6a1010 100%);
  border: 1px solid var(--cog-red-bright);
  border-radius: 2px;
  color: var(--text-bright);
  font-family: var(--font-head); font-size: 10px; font-weight: 700; letter-spacing: 1px;
  padding: 8px 14px; cursor: pointer;
  transition: all 0.15s; text-transform: uppercase;
}
.btn-add-unit:hover { background: linear-gradient(135deg, var(--cog-red-bright) 0%, var(--cog-red) 100%); box-shadow: 0 0 12px rgba(192,57,43,0.4); }

/* Unit categories */
.unit-category { margin-bottom: 16px; }
.cat-label {
  font-family: var(--font-mono); font-size: 10px; color: var(--cog-gold);
  letter-spacing: 3px; text-transform: uppercase;
  padding: 4px 0; border-bottom: 1px solid var(--border);
  margin-bottom: 8px; display: flex; align-items: center; gap: 8px;
}
.cat-label::after { content: ''; flex: 1; height: 1px; background: var(--border); }

/* Unit card */
.unit-card {
  background: var(--steel);
  border: 1px solid var(--border);
  border-radius: 2px;
  margin-bottom: 6px;
  overflow: hidden;
  transition: border-color 0.15s;
}
.unit-card:hover { border-color: var(--cog-gold-dark); }
.unit-card-header {
  display: flex; align-items: center;
  padding: 8px 12px;
  background: rgba(255,255,255,0.02);
  gap: 8px;
  cursor: pointer;
  user-select: none;
}
.unit-card-header:hover { background: rgba(200,168,75,0.05); }
.unit-expand-btn { color: var(--text-dim); font-size: 12px; transition: transform 0.2s; min-width: 14px; }
.unit-card.expanded .unit-expand-btn { transform: rotate(90deg); }
.unit-name { font-family: var(--font-head); font-size: 12px; font-weight: 700; color: var(--text-bright); flex: 1; letter-spacing: 0.5px; }
.unit-pts-badge {
  background: rgba(200,168,75,0.15); border: 1px solid var(--cog-gold-dark);
  border-radius: 2px; padding: 2px 8px;
  font-family: var(--font-mono); font-size: 12px; color: var(--cog-gold); font-weight: bold;
}
.unit-count-ctrl {
  display: flex; align-items: center; gap: 4px;
}
.count-btn {
  background: rgba(255,255,255,0.05); border: 1px solid var(--border);
  border-radius: 2px; color: var(--text); cursor: pointer;
  width: 20px; height: 20px; display: flex; align-items: center; justify-content: center;
  font-size: 14px; font-family: var(--font-mono); line-height: 1;
  transition: all 0.12s;
}
.count-btn:hover { background: rgba(200,168,75,0.2); border-color: var(--cog-gold); color: var(--cog-gold); }
.count-val { font-family: var(--font-mono); font-size: 13px; color: var(--text-bright); min-width: 20px; text-align: center; }
.remove-btn {
  background: rgba(192,57,43,0.1); border: 1px solid rgba(192,57,43,0.3);
  border-radius: 2px; color: var(--cog-red-bright); cursor: pointer;
  width: 20px; height: 20px; display: flex; align-items: center; justify-content: center;
  font-size: 14px; font-weight: bold; transition: all 0.12s; margin-left: 4px;
}
.remove-btn:hover { background: rgba(192,57,43,0.3); border-color: var(--cog-red-bright); }

/* Unit details */
.unit-details { padding: 10px 12px; border-top: 1px solid var(--border); display: none; }
.unit-card.expanded .unit-details { display: block; }

/* Stats bar */
.stats-bar {
  display: flex; gap: 0; margin-bottom: 10px;
  border: 1px solid var(--border); border-radius: 2px; overflow: hidden;
}
.stat-cell {
  flex: 1; text-align: center; padding: 4px 2px;
  border-right: 1px solid var(--border);
}
.stat-cell:last-child { border-right: none; }
.stat-lbl { font-family: var(--font-mono); font-size: 8px; color: var(--text-dim); text-transform: uppercase; }
.stat-val { font-family: var(--font-mono); font-size: 14px; color: var(--text-bright); font-weight: bold; }
.stat-cell.invul { background: rgba(74,143,255,0.1); }
.stat-cell.invul .stat-val { color: var(--accent-blue); }

/* Leader attachment */
.leader-attach-section { margin-bottom: 10px; }
.section-lbl { font-family: var(--font-mono); font-size: 9px; color: var(--cog-gold); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 5px; }
.leader-select {
  background: var(--steel-dark); border: 1px solid var(--border);
  color: var(--text); font-family: var(--font-body); font-size: 13px;
  padding: 5px 8px; border-radius: 2px; width: 100%; cursor: pointer;
  transition: border-color 0.15s;
}
.leader-select:focus { outline: none; border-color: var(--cog-gold); }
.leader-select option { background: var(--steel-dark); }
.attached-leader-badge {
  display: inline-flex; align-items: center; gap: 6px;
  background: rgba(200,168,75,0.1); border: 1px solid var(--cog-gold-dark);
  border-radius: 2px; padding: 4px 8px; margin-top: 5px;
  font-size: 11px; color: var(--cog-gold);
}

/* Weapons table */
.weapon-table { width: 100%; border-collapse: collapse; margin-top: 4px; font-size: 11px; }
.weapon-table th {
  font-family: var(--font-mono); font-size: 9px; color: var(--text-dim);
  letter-spacing: 1px; text-transform: uppercase; text-align: center;
  padding: 3px 4px; background: rgba(255,255,255,0.03);
  border-bottom: 1px solid var(--border);
}
.weapon-table th:first-child { text-align: left; }
.weapon-table td { padding: 4px 4px; border-bottom: 1px solid rgba(200,168,75,0.08); text-align: center; vertical-align: middle; }
.weapon-table td:first-child { text-align: left; color: var(--text); }
.weapon-table tr:last-child td { border-bottom: none; }
.weapon-table tr:hover td { background: rgba(200,168,75,0.04); }
.w-type-badge {
  display: inline-block;
  font-family: var(--font-mono); font-size: 9px;
  padding: 1px 5px; border-radius: 2px;
  color: var(--text-dim);
}
.w-ranged { background: rgba(74,143,255,0.15); color: #7ab4ff; border: 1px solid rgba(74,143,255,0.2); }
.w-melee { background: rgba(192,57,43,0.15); color: #e87070; border: 1px solid rgba(192,57,43,0.2); }
.w-keywords { font-family: var(--font-mono); font-size: 9px; color: var(--machine-green); font-style: italic; }
.weapon-name { font-weight: 600; }

/* Optional weapon selector */
.weapon-opt-row { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
.weapon-opt-label { font-size: 11px; color: var(--text-dim); flex: 0 0 auto; width: 130px; }
.weapon-opt-select {
  background: var(--steel-dark); border: 1px solid var(--border);
  color: var(--text); font-family: var(--font-body); font-size: 12px;
  padding: 3px 6px; border-radius: 2px; flex: 1; cursor: pointer;
}
.weapon-opt-select:focus { outline: none; border-color: var(--cog-gold); }

/* Abilities */
.abilities-section { margin-top: 10px; }
.ability-item { padding: 5px 0; border-bottom: 1px solid rgba(200,168,75,0.06); }
.ability-item:last-child { border-bottom: none; }
.ability-name { font-family: var(--font-mono); font-size: 10px; color: var(--machine-green); font-weight: bold; }
.ability-text { font-size: 11px; color: var(--text-dim); line-height: 1.4; margin-top: 2px; }
.keyword-list { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 8px; }
.kw-badge {
  background: rgba(255,255,255,0.04); border: 1px solid rgba(200,168,75,0.2);
  border-radius: 2px; padding: 1px 6px;
  font-family: var(--font-mono); font-size: 9px; color: var(--text-dim); text-transform: uppercase;
}

/* ===== ADD UNIT MODAL ===== */
.modal-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.85); backdrop-filter: blur(4px);
  z-index: 1000; display: none; align-items: flex-start; justify-content: center;
  padding: 20px; overflow-y: auto;
}
.modal-overlay.open { display: flex; }
.modal {
  background: var(--panel);
  border: 1px solid var(--cog-gold);
  border-radius: 2px;
  width: 100%; max-width: 900px;
  position: relative;
  margin: auto;
}
.modal-header {
  padding: 14px 16px;
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
  background: rgba(200,168,75,0.08);
}
.modal-title { font-family: var(--font-head); font-size: 13px; font-weight: 700; color: var(--cog-gold); letter-spacing: 2px; text-transform: uppercase; }
.modal-close {
  background: rgba(192,57,43,0.2); border: 1px solid rgba(192,57,43,0.4);
  color: var(--cog-red-bright); font-size: 18px; font-weight: bold;
  width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;
  cursor: pointer; border-radius: 2px; line-height: 1;
  transition: all 0.12s;
}
.modal-close:hover { background: rgba(192,57,43,0.4); }
.modal-body { padding: 14px; }
.modal-search {
  background: var(--steel-dark); border: 1px solid var(--border);
  color: var(--text); font-family: var(--font-mono); font-size: 13px;
  padding: 8px 12px; border-radius: 2px; width: 100%; margin-bottom: 12px;
}
.modal-search:focus { outline: none; border-color: var(--cog-gold); }
.modal-search::placeholder { color: var(--text-dim); }
.modal-grid {
  display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;
  max-height: 60vh; overflow-y: auto;
}
.modal-unit-btn {
  background: var(--steel); border: 1px solid var(--border);
  border-radius: 2px; padding: 10px;
  cursor: pointer; text-align: left; transition: all 0.15s;
  display: flex; flex-direction: column; gap: 3px;
}
.modal-unit-btn:hover { background: rgba(200,168,75,0.1); border-color: var(--cog-gold); }
.mu-name { font-family: var(--font-head); font-size: 11px; font-weight: 700; color: var(--text-bright); text-transform: uppercase; }
.mu-type { font-family: var(--font-mono); font-size: 9px; color: var(--text-dim); text-transform: uppercase; }
.mu-pts { font-family: var(--font-mono); font-size: 11px; color: var(--cog-gold); }
.modal-cat-header {
  grid-column: 1/-1;
  font-family: var(--font-mono); font-size: 10px; color: var(--cog-gold);
  letter-spacing: 3px; text-transform: uppercase;
  padding: 6px 0; border-bottom: 1px solid var(--border);
  margin-top: 6px;
}

/* ===== DOCTRINE DISPLAY ===== */
.doctrine-bar {
  background: var(--panel); border: 1px solid var(--border);
  border-radius: 2px; padding: 10px 14px;
  display: flex; align-items: center; gap: 12px; margin-bottom: 14px;
  position: relative; overflow: hidden;
}
.doctrine-bar::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
  background: linear-gradient(90deg, transparent, var(--cog-gold), transparent);
}
.doctrine-label { font-family: var(--font-mono); font-size: 9px; color: var(--text-dim); letter-spacing: 2px; text-transform: uppercase; }
.doctrine-toggle {
  display: flex; gap: 4px; flex: 1;
}
.doc-btn {
  flex: 1; padding: 6px 10px; border-radius: 2px; cursor: pointer;
  font-family: var(--font-head); font-size: 10px; font-weight: 700; letter-spacing: 1px;
  text-transform: uppercase; text-align: center; transition: all 0.15s;
  border: 1px solid var(--border); background: rgba(255,255,255,0.03); color: var(--text-dim);
}
.doc-btn.active-pro { background: rgba(74,143,255,0.2); border-color: var(--accent-blue); color: var(--accent-blue); box-shadow: 0 0 8px rgba(74,143,255,0.2); }
.doc-btn.active-con { background: rgba(192,57,43,0.2); border-color: var(--cog-red-bright); color: var(--cog-red-bright); box-shadow: 0 0 8px rgba(192,57,43,0.2); }
.doctrine-bonus {
  font-family: var(--font-mono); font-size: 10px; color: var(--text-dim);
  min-width: 200px; line-height: 1.5;
}

/* Scrollbar */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: var(--steel-dark); }
::-webkit-scrollbar-thumb { background: var(--cog-gold-dark); border-radius: 3px; }

/* Responsive */
@media (max-width: 900px) {
  .main { grid-template-columns: 1fr; }
  .modal-grid { grid-template-columns: 1fr 1fr; }
}
@media (max-width: 600px) {
  .modal-grid { grid-template-columns: 1fr; }
  .header-cog { display: none; }
}

.empty-roster {
  text-align: center; padding: 40px;
  border: 1px dashed var(--border); border-radius: 2px;
  color: var(--text-dim);
}
.empty-roster-icon { font-size: 36px; margin-bottom: 8px; opacity: 0.4; }
.empty-roster-text { font-family: var(--font-mono); font-size: 12px; letter-spacing: 2px; }

.section-divider {
  font-family: var(--font-mono); font-size: 10px; color: var(--cog-gold);
  letter-spacing: 2px; text-transform: uppercase;
  margin: 10px 0 6px;
  display: flex; align-items: center; gap: 8px;
}
.section-divider::before, .section-divider::after {
  content: ''; flex: 1; height: 1px; background: var(--border);
}

/* Tooltip */
.tip { position: relative; cursor: help; }
.tip::after {
  content: attr(data-tip);
  position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
  background: var(--steel-dark); border: 1px solid var(--cog-gold-dark);
  color: var(--text); font-size: 10px; padding: 4px 8px; border-radius: 2px;
  white-space: nowrap; z-index: 100; pointer-events: none; opacity: 0; transition: opacity 0.15s;
  margin-bottom: 4px;
}
.tip:hover::after { opacity: 1; }
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <div class="header-inner">
    <div class="header-cog">⚙</div>
    <div class="header-text">
      <div class="header-subtitle">Warhammer 40,000 // 10th Edition</div>
      <div class="header-title">Army Builder</div>
      <div class="header-faction">Adeptus Mechanicus — Cult of the Omnissiah</div>
    </div>
    <div class="header-points">
      <div class="pts-label">TOTAL POINTS</div>
      <div class="pts-value" id="total-pts">0</div>
      <div class="pts-limit">/ 2000 pts</div>
    </div>
  </div>
</div>

<!-- MAIN -->
<div class="main">

  <!-- LEFT PANEL -->
  <div>
    <!-- Army Rule -->
    <div class="panel" style="margin-bottom:16px;">
      <div class="panel-header">
        <span class="panel-header-icon">◈</span>
        <span class="panel-header-title">Army Rule</span>
      </div>
      <div class="panel-body">
        <div class="army-rule">
          <div class="army-rule-header">
            <div class="army-rule-icon">⚙</div>
            <div class="army-rule-title">Doctrina Imperatives</div>
          </div>
          <div class="imperative-tabs">
            <div class="imp-tab active-pro" onclick="showImperative('pro',this)" id="tab-pro">Protector</div>
            <div class="imp-tab" onclick="showImperative('con',this)" id="tab-con">Conqueror</div>
          </div>
          <div class="imperative-content" id="imperative-text">
            <ul>
              <li>Ranged weapons gain [HEAVY]</li>
              <li>Improve BS of ranged weapons by 1</li>
              <li>Subtract 1 from Hit rolls of melee attacks targeting BATTLELINE units or units within 6" of BATTLELINE</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Detachment Selector -->
    <div class="panel">
      <div class="panel-header">
        <span class="panel-header-icon">▣</span>
        <span class="panel-header-title">Detachment</span>
      </div>
      <div class="panel-body">
        <div class="det-list" id="det-list"></div>
        <div class="det-rule-box" id="det-rule-box">
          <div class="det-rule-label">Detachment Rule</div>
          <div class="det-rule-title" id="det-rule-title">Select a Detachment</div>
          <div class="det-rule-text" id="det-rule-text">Choose a detachment above to see its special rules.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- RIGHT PANEL: ROSTER -->
  <div>
    <!-- Doctrine bar -->
    <div class="doctrine-bar">
      <div class="doctrine-label">Active<br>Doctrine</div>
      <div class="doctrine-toggle">
        <div class="doc-btn active-pro" id="doc-pro" onclick="setDocBanner('pro')">⬡ PROTECTOR<br><span style="font-size:8px;letter-spacing:0">+1 BS • Heavy • -1 Hit vs Melee</span></div>
        <div class="doc-btn" id="doc-con" onclick="setDocBanner('con')">⬡ CONQUEROR<br><span style="font-size:8px;letter-spacing:0">+1 WS • Assault • +1 AP (near BL)</span></div>
      </div>
    </div>

    <!-- Roster -->
    <div class="panel">
      <div class="panel-header" style="justify-content:space-between;">
        <div style="display:flex;align-items:center;gap:8px;">
          <span class="panel-header-icon">◉</span>
          <span class="panel-header-title">Army Roster</span>
        </div>
        <button class="btn-add-unit" onclick="openModal()">+ Add Unit</button>
      </div>
      <div class="panel-body" id="roster-body">
        <div class="empty-roster" id="empty-state">
          <div class="empty-roster-icon">⚙</div>
          <div class="empty-roster-text">No units deployed. Praise the Omnissiah.</div>
        </div>
        <div id="roster-list"></div>
      </div>
    </div>
  </div>
</div>

<!-- ADD UNIT MODAL -->
<div class="modal-overlay" id="modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">◈ Requisition Unit — Datasheet Registry</div>
      <div class="modal-close" onclick="closeModal()">✕</div>
    </div>
    <div class="modal-body">
      <input class="modal-search" type="text" placeholder="Search unit name..." id="unit-search" oninput="filterUnits()" />
      <div class="modal-grid" id="modal-grid"></div>
    </div>
  </div>
</div>

<script>
// ============================
// DATA
// ============================

const DETACHMENTS = [
  {
    id: 'rad',
    name: 'Rad-Zone Corps',
    short: 'Rad radiation bombardment, early mortal wounds, Battleline synergies',
    ruleName: 'Rad-bombardment',
    ruleText: 'At the start of battle round 1, for each enemy unit in opponent\'s deployment zone, your opponent chooses: stand firm (D3 MWs on 3+) or take cover (Battle-shocked; D3 MWs on 5+). Rounds 2–5: roll D6 for each enemy unit in opponent\'s deployment zone — on 3+ it takes 1 MW and must take a Battle-shock test.'
  },
  {
    id: 'skitarii',
    name: 'Skitarii Hunter Cohort',
    short: 'Stealth for all Skitarii infantry/mounted/Ironstriders. Sicarians get cover vs ranged 12"+',
    ruleName: 'Stealth Optimisation',
    ruleText: 'SKITARII INFANTRY, SKITARII MOUNTED and IRONSTRIDER BALLISTARII units from your army have the Stealth ability. Each time a ranged attack targets a SICARIAN unit from your army, unless the attacking model is within 12", the target has the Benefit of Cover against that attack.'
  },
  {
    id: 'psalm',
    name: 'Data-Psalm Conclave',
    short: 'Cycle benedictions each Command phase for Cult Mechanicus units (+AP, +D, resilience)',
    ruleName: 'Benedictions of the Omnissiah',
    ruleText: 'At the start of your Command phase, select one Benediction of the Omnissiah to be active for your army until the start of your next Command phase. CULT MECHANICUS units gain the active Benediction\'s bonus. Options include: +1 AP on all attacks, Feel No Pain 5+, and more powerful offensive/defensive buffs.'
  },
  {
    id: 'explorator',
    name: 'Explorator Maniple',
    short: 'Choose one Acquisition objective each Command phase; bonuses while targeting units near it',
    ruleName: 'Acquisition at Any Cost',
    ruleText: 'At the start of your Command phase, select one objective marker in No Man\'s Land or your opponent\'s territory — this becomes your Acquisition target. ADEPTUS MECHANICUS units from your army can re-roll Wound rolls when targeting enemy units within range of that objective marker.'
  },
  {
    id: 'cyber',
    name: 'Cohort Cybernetica',
    short: 'LEGIO CYBERNETICA (Kastelan Robots) gain special Cyber-psalm protocols and multiple stratagems',
    ruleName: 'Cyber-Psalm Programming',
    ruleText: 'LEGIO CYBERNETICA units (Kastelan Robots + Cybernetica Datasmith) from your army have the Doctrina Imperatives ability. At the start of your Command phase, you can select one LEGIO CYBERNETICA unit to receive a Cyber-psalm bonus until the end of the turn (e.g. +2" Move, or reroll hit rolls).'
  },
  {
    id: 'haloscreed',
    name: 'Haloscreed Battle Clade',
    short: 'Noospheric Transference: buff 2 units per turn with movement, toughness, stealth or charge bonuses',
    ruleName: 'Noospheric Transference',
    ruleText: 'At the start of your Command phase, select up to two ADEPTUS MECHANICUS units from your army. Each selected unit gains one of: +2" Move and Advance & Charge, +1 Toughness, or the Stealth ability — until the start of your next Command phase. Both units can receive different benefits.'
  }
];

// ======= UNIT DATABASE =======
// Points are as accurate as possible from Munitorum Field Manual (latest ~Feb 2026)
// Feb 2026 changes: Cawl +35, Ironstrider Ballistarii +10-30 across sizes, Pteraxii/Sicarians +5-15
// All weapon profiles sourced from Wahapedia

const UNITS = [
  // ---- CHARACTERS ----
  {
    id:'cawl', name:'Belisarius Cawl', role:'Character', type:'Epic Hero',
    pts: 245, // 210 + ~35 Feb 2026 nerf
    M:'8"', T:8, Sv:'2+', W:10, Ld:'6+', OC:3, invul:'4+',
    keywords:['MONSTER','CHARACTER','EPIC HERO','TECH-PRIEST','CULT MECHANICUS'],
    abilities:[
      {name:'Canticles of the Omnissiah', text:'Each Command phase select one: Machine Vengeance (re-roll Hit rolls vs 1 target), Mantra of Discipline (+1 OC/Leadership aura), or Shroudpsalm (Stealth aura 6").'},
      {name:'Mechanicus Bodyguard', text:'While within 3" of another ADEPTUS MECHANICUS unit, this model has Lone Operative.'},
      {name:'Self-repair Mechanisms', text:'Regains up to D3 lost wounds each Command phase.'},
      {name:'Supreme Commander', text:'Must be your Warlord if included.'}
    ],
    ranged:[
      {name:'Solar atomiser', range:'18"', a:3, bs:'2+', s:14, ap:'-4', d:'D6', keywords:'[MELTA 3]'},
    ],
    melee:[
      {name:'Arc scourge', a:4, ws:'2+', s:5, ap:'-1', d:1, keywords:'[ANTI-VEHICLE 4+][DEVASTATING WOUNDS][EXTRA ATTACKS]'},
      {name:"Cawl's Omnissian axe", a:4, ws:'2+', s:8, ap:'-2', d:2, keywords:''},
      {name:'Mechadendrite hive', a:'2D6', ws:'3+', s:4, ap:'0', d:1, keywords:'[EXTRA ATTACKS]'},
    ],
    canLead:[], isLeader:true, noAttach:true
  },
  {
    id:'datasmith', name:'Cybernetica Datasmith', role:'Character', type:'Infantry',
    pts: 50,
    M:'6"', T:4, Sv:'3+', W:4, Ld:'6+', OC:1, invul:'5+',
    keywords:['CHARACTER','INFANTRY','TECH-PRIEST','LEGIO CYBERNETICA'],
    abilities:[
      {name:'Cyber-psalm Directive', text:'Once per Command phase, select one friendly KASTELAN ROBOTS unit within 9": it gains one protocol bonus until start of next Command phase (e.g. cannot Advance but gains +2 to Hit rolls, or gains +2" Move etc).'},
      {name:'Reprogramming', text:'Once per battle, use instead of shooting: select a friendly KASTELAN ROBOTS unit within 3" and change its active protocol.'}
    ],
    ranged:[
      {name:'Phosphor blaster', range:'18"', a:2, bs:'3+', s:5, ap:'-1', d:1, keywords:'[LETHAL HITS]'},
    ],
    melee:[
      {name:'Servo-fist', a:3, ws:'3+', s:6, ap:'-1', d:1, keywords:''},
    ],
    canLead:['robots'],
    isLeader:true
  },
  {
    id:'marshal', name:'Skitarii Marshal', role:'Character', type:'Infantry',
    pts: 45,
    M:'6"', T:4, Sv:'4+', W:4, Ld:'6+', OC:1, invul:'6+',
    keywords:['CHARACTER','INFANTRY','SKITARII'],
    abilities:[
      {name:'Coordinated Assault', text:'Once per Command phase, select one friendly SKITARII unit within 6": until end of turn, add 1 to its Advance and Charge rolls.'},
      {name:'Mechadendritic Uplink', text:'While leading a unit, models in that unit have the Doctrina Imperatives ability (if they don\'t already).'}
    ],
    ranged:[
      {name:'Radium pistol', range:'12"', a:1, bs:'3+', s:3, ap:'0', d:1, keywords:'[PISTOL][ANTI-INFANTRY 2+]'},
      {name:'Mechanicus pistol', range:'12"', a:1, bs:'3+', s:4, ap:'-1', d:1, keywords:'[PISTOL]'},
    ],
    weaponOptions:[
      {slot:'ranged1', label:'Pistol', options:['Radium pistol','Mechanicus pistol']}
    ],
    melee:[
      {name:'Marshal\'s blade', a:4, ws:'3+', s:5, ap:'-2', d:1, keywords:''},
    ],
    canLead:['rangers','vanguard','infiltrators','ruststalkers','pteraxii_sky','pteraxii_ster','serberys_raiders','serberys_sulph'],
    isLeader:true
  },
  {
    id:'skatros', name:'Sydonian Skatros', role:'Character', type:'Infantry',
    pts: 65,
    M:'6"', T:4, Sv:'3+', W:4, Ld:'6+', OC:0, invul:'6+',
    keywords:['CHARACTER','INFANTRY','SKITARII','LONE OPERATIVE'],
    abilities:[
      {name:'Lone Operative', text:'While not within 3" of friendly non-CHARACTER units, this model cannot be targeted by ranged attacks unless it is the closest eligible target.'},
      {name:'Precision Strike', text:'Each time this model makes an attack that targets an enemy CHARACTER, that attack has the [PRECISION] ability.'},
      {name:'Hyperstealth Protocol', text:'While in cover or within 3" of cover, this model has the Stealth ability.'}
    ],
    ranged:[
      {name:'Flechette carbine', range:'18"', a:4, bs:'2+', s:4, ap:'0', d:1, keywords:'[PRECISION]'},
      {name:'Phosphor serpenta', range:'18"', a:2, bs:'2+', s:5, ap:'-1', d:2, keywords:'[LETHAL HITS][PRECISION]'},
    ],
    weaponOptions:[
      {slot:'ranged1', label:'Weapon', options:['Flechette carbine','Phosphor serpenta']}
    ],
    melee:[
      {name:'Skatros blades', a:4, ws:'3+', s:4, ap:'-1', d:1, keywords:'[PRECISION]'},
    ],
    canLead:[], isLeader:false, noAttach:true
  },
  {
    id:'dominus', name:'Tech-Priest Dominus', role:'Character', type:'Infantry',
    pts: 95,
    M:'6"', T:4, Sv:'2+', W:5, Ld:'6+', OC:1, invul:'4+',
    keywords:['CHARACTER','INFANTRY','TECH-PRIEST','CULT MECHANICUS'],
    abilities:[
      {name:'Omnissiah\'s Envoy', text:'Friendly CULT MECHANICUS models within 6" have Feel No Pain 4+. (Invulnerable save improves to 4+ vs mortal wounds from this aura.)'},
      {name:'Logi Binaric Analysis', text:'Each Command phase, select one friendly ADEPTUS MECHANICUS unit within 9". That unit gains +1 to all Wound rolls until start of next Command phase.'}
    ],
    ranged:[
      {name:'Volkite blaster', range:'18"', a:3, bs:'2+', s:6, ap:0, d:2, keywords:'[DEVASTATING WOUNDS]'},
      {name:'Macrostubber', range:'18"', a:5, bs:'2+', s:4, ap:0, d:1, keywords:''},
    ],
    weaponOptions:[
      {slot:'ranged1', label:'Ranged weapon', options:['Volkite blaster','Macrostubber']}
    ],
    melee:[
      {name:'Omnissian axe', a:4, ws:'3+', s:6, ap:'-2', d:2, keywords:''},
      {name:'Eradication ray', range:'18"', a:2, bs:'2+', s:8, ap:'-4', d:'D3+3', keywords:'[MELTA 2]'},
    ],
    weaponOptionsM:[
      {slot:'melee1', label:'Melee weapon', options:['Omnissian axe']}
    ],
    canLead:['rangers','vanguard','fulgurites','corpuscarii','breachers','destroyers'],
    isLeader:true
  },
  {
    id:'enginseer', name:'Tech-Priest Enginseer', role:'Character', type:'Infantry',
    pts: 45,
    M:'6"', T:4, Sv:'3+', W:3, Ld:'6+', OC:1, invul:'6+',
    keywords:['CHARACTER','INFANTRY','TECH-PRIEST','CULT MECHANICUS'],
    abilities:[
      {name:'Omnissiah\'s Blessing', text:'Command phase: select one friendly ADEPTUS MECHANICUS model within 3". It regains D3 lost wounds. VEHICLE models also gain Feel No Pain 5+ until start of next Command phase.'},
      {name:'Enginseer', text:'While within 3" of one or more friendly ADEPTUS MECHANICUS VEHICLE units, unless leading a unit, this model has the Lone Operative ability.'}
    ],
    ranged:[
      {name:'Servo-arm (ranged)', range:'12"', a:1, bs:'4+', s:6, ap:0, d:1, keywords:''},
    ],
    melee:[
      {name:'Servo-arm', a:2, ws:'4+', s:8, ap:'-2', d:3, keywords:''},
      {name:'Omnissian axe', a:3, ws:'4+', s:5, ap:'-1', d:1, keywords:''},
    ],
    canLead:['servitors'],
    isLeader:true
  },
  {
    id:'manipulus', name:'Tech-Priest Manipulus', role:'Character', type:'Infantry',
    pts: 80,
    M:'6"', T:4, Sv:'3+', W:5, Ld:'6+', OC:1, invul:'5+',
    keywords:['CHARACTER','INFANTRY','TECH-PRIEST','CULT MECHANICUS'],
    abilities:[
      {name:'Galvanic Field', text:'While this model is leading a unit, weapons equipped by models in that unit have the [LETHAL HITS] ability.'},
      {name:'Invigorating Pulse', text:'Command phase: select one friendly SKITARII or CULT MECHANICUS INFANTRY unit within 9". Until end of Shooting phase, that unit can shoot as if it had not Advanced this turn.'}
    ],
    ranged:[
      {name:'Transonic cannon', range:'9"', a:3, bs:'3+', s:7, ap:'-1', d:3, keywords:'[BLAST]'},
      {name:'Magnarail lance', range:'30"', a:1, bs:'2+', s:10, ap:'-3', d:'D3+3', keywords:'[HEAVY]'},
    ],
    weaponOptions:[
      {slot:'ranged1', label:'Main weapon', options:['Transonic cannon','Magnarail lance']}
    ],
    melee:[
      {name:'Omnissian staff', a:4, ws:'3+', s:6, ap:'-1', d:2, keywords:''},
    ],
    canLead:['rangers','vanguard','fulgurites','corpuscarii'],
    isLeader:true
  },
  {
    id:'technoarcheologist', name:'Technoarcheologist', role:'Character', type:'Infantry',
    pts: 45,
    M:'6"', T:4, Sv:'3+', W:4, Ld:'6+', OC:1, invul:'5+',
    keywords:['CHARACTER','INFANTRY','SKITARII'],
    abilities:[
      {name:'Archeotech Discovery', text:'Once per game, in your Command phase, select one friendly ADEPTUS MECHANICUS unit within 6". Until end of turn, weapons equipped by models in that unit have the [LETHAL HITS] and [SUSTAINED HITS 1] abilities.'},
      {name:'Relic Cache', text:'Once per battle, you can give one model in a friendly unit within 3" the benefit of an additional Warlord Trait (chosen from your Detachment Enhancements).'}
    ],
    ranged:[
      {name:'Servo-pistol', range:'12"', a:2, bs:'3+', s:4, ap:'-1', d:1, keywords:'[PISTOL]'},
    ],
    melee:[
      {name:'Archeological tools', a:3, ws:'3+', s:4, ap:0, d:1, keywords:''},
    ],
    canLead:['rangers','vanguard'],
    isLeader:true
  },

  // ---- BATTLELINE ----
  {
    id:'rangers', name:'Skitarii Rangers', role:'Battleline', type:'Infantry',
    ptsBase: 75, ptsMax: 130, // 5-10 models at ~13pts/model
    pts: 75, minModels:5, maxModels:10, ptsPerModel:15,
    M:'6"', T:3, Sv:'4+', W:1, Ld:'6+', OC:2, invul:null,
    keywords:['INFANTRY','BATTLELINE','SKITARII','DOCTRINA IMPERATIVES'],
    abilities:[
      {name:'Scout 6"', text:'Before the battle begins, this unit can move up to 6".'},
      {name:'Rangers of the Omnissiah', text:'Each time a model in this unit makes a ranged attack, you can re-roll a Hit roll of 1. If target is within 12", you can also re-roll Wound rolls of 1.'},
    ],
    ranged:[
      {name:'Galvanic rifle', range:'30"', a:2, bs:'3+', s:4, ap:0, d:1, keywords:'[HEAVY]'},
      {name:'Transuranic arquebus', range:'60"', a:1, bs:'3+', s:7, ap:'-2', d:2, keywords:'[HEAVY][PRECISION]'},
      {name:'Arc rifle', range:'30"', a:1, bs:'3+', s:6, ap:'-1', d:2, keywords:'[ANTI-VEHICLE 4+]'},
      {name:'Plasma caliver (standard)', range:'24"', a:2, bs:'3+', s:7, ap:'-2', d:1, keywords:''},
      {name:'Plasma caliver (supercharge)', range:'24"', a:2, bs:'3+', s:8, ap:'-3', d:2, keywords:'[HAZARDOUS]'},
    ],
    weaponOptions:[
      {slot:'ranged1', label:'Trooper weapon', options:['Galvanic rifle']},
      {slot:'ranged2', label:'Special weapons (up to 2 per 5 models)', options:['Arc rifle','Transuranic arquebus','Plasma caliver (standard)','Plasma caliver (supercharge)']}
    ],
    melee:[
      {name:'Skitarii combat blade', a:1, ws:'4+', s:3, ap:0, d:1, keywords:''},
    ]
  },
  {
    id:'vanguard', name:'Skitarii Vanguard', role:'Battleline', type:'Infantry',
    pts: 75, minModels:5, maxModels:10, ptsPerModel:15,
    M:'6"', T:3, Sv:'4+', W:1, Ld:'6+', OC:2, invul:null,
    keywords:['INFANTRY','BATTLELINE','SKITARII','DOCTRINA IMPERATIVES'],
    abilities:[
      {name:'Rad-saturation (Aura)', text:'While an enemy unit is within 3" of this unit, subtract 1 from the Objective Control characteristic of models in that enemy unit (excluding VEHICLE models).'},
      {name:'Close Cohort Vox', text:'While this unit has BATTLELINE, friendly ADEPTUS MECHANICUS INFANTRY units within 6" have their Objective Control increased by 1 when contesting objectives.'},
    ],
    ranged:[
      {name:'Radium carbine', range:'18"', a:3, bs:'3+', s:3, ap:0, d:1, keywords:'[ANTI-INFANTRY 2+]'},
      {name:'Arc rifle', range:'30"', a:1, bs:'3+', s:6, ap:'-1', d:2, keywords:'[ANTI-VEHICLE 4+]'},
      {name:'Plasma caliver (standard)', range:'24"', a:2, bs:'3+', s:7, ap:'-2', d:1, keywords:''},
      {name:'Plasma caliver (supercharge)', range:'24"', a:2, bs:'3+', s:8, ap:'-3', d:2, keywords:'[HAZARDOUS]'},
    ],
    weaponOptions:[
      {slot:'ranged1', label:'Trooper weapon', options:['Radium carbine']},
      {slot:'ranged2', label:'Special weapon (up to 2 per 5)', options:['Arc rifle','Plasma caliver (standard)','Plasma caliver (supercharge)']}
    ],
    melee:[
      {name:'Skitarii combat blade', a:1, ws:'4+', s:3, ap:0, d:1, keywords:''},
    ]
  },

  // ---- OTHER ----
  {
    id:'corpuscarii', name:'Corpuscarii Electro-Priests', role:'Other', type:'Infantry',
    pts: 90, minModels:5, maxModels:10, ptsPerModel:18,
    M:'6"', T:3, Sv:'5+', W:1, Ld:'6+', OC:1, invul:'5+',
    keywords:['INFANTRY','CULT MECHANICUS','DOCTRINA IMPERATIVES'],
    abilities:[
      {name:'Feel No Pain 5+', text:'This unit has Feel No Pain 5+.'},
      {name:'Electrostatic Overload', text:'Each time a model in this unit makes an attack, if the attack hits, one enemy unit hit must subtract 2" from Movement, Advance, and Charge until end of opponent\'s next turn (once per unit per phase).'},
    ],
    ranged:[
      {name:'Electrostatic gauntlets', range:'12"', a:3, bs:'3+', s:5, ap:0, d:1, keywords:'[PISTOL][SUSTAINED HITS 2]'},
    ],
    melee:[
      {name:'Electrostatic gauntlets (melee)', a:3, ws:'4+', s:5, ap:0, d:1, keywords:'[SUSTAINED HITS 2]'},
    ]
  },
  {
    id:'fulgurites', name:'Fulgurite Electro-Priests', role:'Other', type:'Infantry',
    pts: 80, minModels:5, maxModels:10, ptsPerModel:16,
    M:'6"', T:3, Sv:'5+', W:1, Ld:'6+', OC:1, invul:'5+',
    keywords:['INFANTRY','CULT MECHANICUS','DOCTRINA IMPERATIVES'],
    abilities:[
      {name:'Feel No Pain 5+', text:'This unit has Feel No Pain 5+.'},
      {name:'Siphoned Vigour', text:'Each time this unit destroys an enemy model, until the end of the battle, each model in this unit gains +1 to its Save characteristic (max 3+).'},
    ],
    ranged:[],
    melee:[
      {name:'Electroleech stave', a:3, ws:'3+', s:6, ap:'-2', d:2, keywords:'[ANTI-PSYKER 2+]'},
    ]
  },
  {
    id:'infiltrators', name:'Sicarian Infiltrators', role:'Other', type:'Infantry',
    pts: 85, minModels:5, maxModels:10, ptsPerModel:17,
    M:'8"', T:4, Sv:'3+', W:2, Ld:'6+', OC:2, invul:'6+',
    keywords:['INFANTRY','SICARIAN','SKITARII','DOCTRINA IMPERATIVES','INFILTRATORS','SCOUTS 6"'],
    abilities:[
      {name:'Infiltrators', text:'During deployment, can be set up anywhere on the battlefield that is more than 9" from the enemy deployment zone and any enemy models.'},
      {name:'Scouts 6"', text:'Before the battle, can move 6".'},
      {name:'Battle-shock Protocol', text:'Each time this unit destroys an enemy unit, until the end of the battle, that destroyed unit\'s controlling player must re-roll one of their dice (of their choice) at some point this battle.'},
    ],
    ranged:[
      {name:'Flechette blaster', range:'12"', a:5, bs:'3+', s:3, ap:0, d:1, keywords:'[PISTOL]'},
      {name:'Stubcarbine', range:'18"', a:3, bs:'3+', s:4, ap:0, d:1, keywords:''},
    ],
    weaponOptions:[
      {slot:'ranged1', label:'Ranged weapon', options:['Flechette blaster','Stubcarbine']}
    ],
    melee:[
      {name:'Power sword', a:3, ws:'3+', s:4, ap:'-2', d:1, keywords:''},
      {name:'Taser goad', a:3, ws:'3+', s:6, ap:'-1', d:1, keywords:'[TASER]'},
    ],
    weaponOptionsM:[
      {slot:'melee1', label:'Melee weapon', options:['Power sword','Taser goad']}
    ]
  },
  {
    id:'ruststalkers', name:'Sicarian Ruststalkers', role:'Other', type:'Infantry',
    pts: 80, minModels:5, maxModels:10, ptsPerModel:16,
    M:'8"', T:4, Sv:'3+', W:2, Ld:'6+', OC:2, invul:'6+',
    keywords:['INFANTRY','SICARIAN','SKITARII','DOCTRINA IMPERATIVES','SCOUTS 6"'],
    abilities:[
      {name:'Scouts 6"', text:'Before the battle, can move 6".'},
      {name:'Blademaster (Aura)', text:'While within 6" of a friendly BATTLELINE unit, add 1 to this unit\'s Advance and Charge rolls. This bonus becomes +2 when within 6" of two or more BATTLELINE units.'},
    ],
    ranged:[
      {name:'Transonic blades (thrown)', range:'8"', a:4, bs:'4+', s:4, ap:'-1', d:1, keywords:'[ASSAULT]'},
    ],
    melee:[
      {name:'Transonic blades', a:4, ws:'3+', s:4, ap:'-1', d:1, keywords:'[SUSTAINED HITS 1]'},
      {name:'Chordclaw', a:3, ws:'3+', s:5, ap:'-2', d:2, keywords:''},
    ],
    weaponOptionsM:[
      {slot:'melee1', label:'Melee weapon', options:['Transonic blades','Chordclaw']}
    ]
  },
  {
    id:'breachers', name:'Kataphron Breachers', role:'Other', type:'Infantry',
    pts: 145, minModels:3, maxModels:6, ptsPerModel:48,
    M:'5"', T:6, Sv:'3+', W:3, Ld:'6+', OC:2, invul:'5+',
    keywords:['INFANTRY','KATAPHRON','CULT MECHANICUS','DOCTRINA IMPERATIVES'],
    abilities:[
      {name:'Servitor Maniple', text:'While this unit contains 6 models, add 1 to this unit\'s Objective Control characteristic.'},
    ],
    ranged:[
      {name:'Heavy arc rifle', range:'36"', a:2, bs:'3+', s:8, ap:'-2', d:3, keywords:'[ANTI-VEHICLE 4+]'},
      {name:'Arc blaster', range:'12"', a:3, bs:'3+', s:6, ap:'-1', d:2, keywords:'[ANTI-VEHICLE 4+]'},
    ],
    weaponOptions:[
      {slot:'ranged1', label:'Ranged weapon', options:['Heavy arc rifle','Arc blaster']}
    ],
    melee:[
      {name:'Hydraulic claw', a:3, ws:'4+', s:8, ap:'-2', d:2, keywords:''},
      {name:'Arc claw', a:3, ws:'4+', s:6, ap:'-1', d:2, keywords:'[ANTI-VEHICLE 4+]'},
    ],
    weaponOptionsM:[
      {slot:'melee1', label:'Melee weapon', options:['Hydraulic claw','Arc claw']}
    ]
  },
  {
    id:'destroyers', name:'Kataphron Destroyers', role:'Other', type:'Infantry',
    pts: 130, minModels:3, maxModels:6, ptsPerModel:43,
    M:'5"', T:6, Sv:'4+', W:3, Ld:'6+', OC:2, invul:'5+',
    keywords:['INFANTRY','KATAPHRON','CULT MECHANICUS','DOCTRINA IMPERATIVES'],
    abilities:[
      {name:'Doctrina Imperatives', text:'This unit has the Doctrina Imperatives faction rule.'},
    ],
    ranged:[
      {name:'Plasma culverin (standard)', range:'24"', a:4, bs:'3+', s:7, ap:'-2', d:1, keywords:''},
      {name:'Plasma culverin (supercharge)', range:'24"', a:4, bs:'3+', s:8, ap:'-3', d:2, keywords:'[HAZARDOUS]'},
      {name:'Cognis flamer', range:'12"', a:'D6+2', bs:'N/A', s:4, ap:0, d:1, keywords:'[IGNORES COVER][TORRENT]'},
    ],
    weaponOptions:[
      {slot:'ranged1', label:'Main weapon', options:['Plasma culverin (standard)','Plasma culverin (supercharge)','Cognis flamer']}
    ],
    melee:[
      {name:'Servo-claw', a:2, ws:'4+', s:6, ap:'-1', d:1, keywords:''},
    ]
  },
  {
    id:'robots', name:'Kastelan Robots', role:'Other', type:'Vehicle',
    pts: 240, minModels:2, maxModels:6, ptsPerModel:120,
    M:'6"', T:9, Sv:'2+', W:7, Ld:'8+', OC:3, invul:'5+',
    keywords:['VEHICLE','LEGIO CYBERNETICA','DOCTRINA IMPERATIVES'],
    abilities:[
      {name:'Aegis Protocol', text:'The first time this unit is destroyed in melee, roll D6. On 3+, before removing last model, this unit makes a free melee attack.'},
      {name:'Battle Servitors', text:'When targeted by Cybernetica Datasmith\'s Cyber-psalm Directive, gain that bonus.'},
    ],
    ranged:[
      {name:'Kastelan phosphor blaster', range:'18"', a:3, bs:'3+', s:5, ap:'-1', d:1, keywords:'[LETHAL HITS]'},
      {name:'Heavy phosphor blaster', range:'24"', a:4, bs:'3+', s:6, ap:'-1', d:2, keywords:'[LETHAL HITS]'},
    ],
    weaponOptions:[
      {slot:'ranged1', label:'Arm weapons', options:['Kastelan phosphor blaster (×2)','Heavy phosphor blaster (×1)']}
    ],
    melee:[
      {name:'Kastelan fists', a:5, ws:'4+', s:12, ap:'-2', d:3, keywords:''},
    ]
  },
  {
    id:'ironstriders', name:'Ironstrider Ballistarii', role:'Other', type:'Vehicle',
    pts: 90, minModels:1, maxModels:6, ptsPerModel:90,
    M:'8"', T:7, Sv:'3+', W:7, Ld:'6+', OC:2, invul:'5+',
    keywords:['VEHICLE','WALKER','SKITARII','DOCTRINA IMPERATIVES'],
    abilities:[
      {name:'Predictive Targeting', text:'Each time this model makes a ranged attack, it scores a hit on an unmodified Hit roll of 5+, regardless of its BS.'},
      {name:'Dunestrider', text:'This model can move and still shoot without suffering the Heavy weapon penalty.'},
    ],
    ranged:[
      {name:'Twin cognis autocannon', range:'48"', a:4, bs:'3+', s:7, ap:'-1', d:2, keywords:'[TWIN-LINKED]'},
      {name:'Twin cognis lascannon', range:'48"', a:2, bs:'3+', s:12, ap:'-3', d:'D6+1', keywords:'[TWIN-LINKED]'},
    ],
    weaponOptions:[
      {slot:'ranged1', label:'Main weapon', options:['Twin cognis autocannon','Twin cognis lascannon']}
    ],
    melee:[
      {name:'Ironstrider piston legs', a:3, ws:'4+', s:6, ap:'-1', d:1, keywords:''},
    ]
  },
  {
    id:'dragoons_taser', name:'Sydonian Dragoons (Taser Lance)', role:'Other', type:'Vehicle',
    pts: 80, minModels:1, maxModels:6, ptsPerModel:80,
    M:'8"', T:7, Sv:'3+', W:7, Ld:'6+', OC:2, invul:'5+',
    keywords:['VEHICLE','WALKER','MOUNTED','SKITARII','DOCTRINA IMPERATIVES'],
    abilities:[
      {name:'Dunestrider', text:'This model can move and shoot without the Heavy weapon penalty.'},
    ],
    ranged:[
      {name:'Radium serpenta', range:'12"', a:2, bs:'3+', s:3, ap:0, d:1, keywords:'[PISTOL][ANTI-INFANTRY 2+]'},
    ],
    melee:[
      {name:'Taser lance', a:3, ws:'3+', s:7, ap:'-1', d:2, keywords:'[TASER]'},
    ]
  },
  {
    id:'dragoons_radium', name:'Sydonian Dragoons (Radium Jezzail)', role:'Other', type:'Vehicle',
    pts: 65, minModels:1, maxModels:6, ptsPerModel:65,
    M:'8"', T:7, Sv:'3+', W:7, Ld:'6+', OC:2, invul:'5+',
    keywords:['VEHICLE','WALKER','MOUNTED','SKITARII','DOCTRINA IMPERATIVES','STEALTH'],
    abilities:[
      {name:'Stealth', text:'While an attack targets this unit, subtract 1 from the Hit roll if the attacking model is more than 12" away.'},
      {name:'Dunestrider', text:'This model can move and shoot without the Heavy weapon penalty.'},
    ],
    ranged:[
      {name:'Radium jezzail', range:'30"', a:2, bs:'3+', s:5, ap:'-1', d:2, keywords:'[HEAVY][ANTI-INFANTRY 2+]'},
    ],
    melee:[
      {name:'Strider legs', a:3, ws:'4+', s:5, ap:0, d:1, keywords:''},
    ]
  },
  {
    id:'serberys_raiders', name:'Serberys Raiders', role:'Other', type:'Cavalry',
    pts: 80, minModels:3, maxModels:9, ptsPerModel:27,
    M:'12"', T:4, Sv:'4+', W:2, Ld:'6+', OC:2, invul:'6+',
    keywords:['MOUNTED','SKITARII','DOCTRINA IMPERATIVES','SCOUTS 9"'],
    abilities:[
      {name:'Scouts 9"', text:'Before the battle, can move 9".'},
      {name:'Light Cavalry', text:'This unit does not have the BATTLELINE keyword for the purposes of the Protector Imperative.'},
    ],
    ranged:[
      {name:'Galvanic carbine', range:'18"', a:2, bs:'3+', s:4, ap:0, d:1, keywords:''},
      {name:'Cavalry pistol', range:'12"', a:1, bs:'3+', s:4, ap:0, d:1, keywords:'[PISTOL]'},
    ],
    melee:[
      {name:'Serberys blade', a:2, ws:'4+', s:4, ap:0, d:1, keywords:''},
      {name:'Hunting blade (Alpha)', a:4, ws:'3+', s:5, ap:'-1', d:1, keywords:''},
    ]
  },
  {
    id:'serberys_sulph', name:'Serberys Sulphurhounds', role:'Other', type:'Cavalry',
    pts: 85, minModels:3, maxModels:9, ptsPerModel:28,
    M:'12"', T:4, Sv:'4+', W:2, Ld:'6+', OC:2, invul:'6+',
    keywords:['MOUNTED','SKITARII','DOCTRINA IMPERATIVES'],
    abilities:[
      {name:'Cavalry Assault', text:'After this unit Advances or charges, each model makes one additional melee attack (not extra attacks characteristic; applies once per phase).'},
    ],
    ranged:[
      {name:'Phosphor pistol (pair)', range:'12"', a:3, bs:'3+', s:4, ap:'-1', d:1, keywords:'[PISTOL][LETHAL HITS]'},
      {name:'Sulphur breath (Alpha)', range:'6"', a:'D3', bs:'N/A', s:3, ap:0, d:1, keywords:'[TORRENT]'},
    ],
    melee:[
      {name:'Cavalry sabre', a:3, ws:'3+', s:4, ap:0, d:1, keywords:''},
    ]
  },
  {
    id:'pteraxii_sky', name:'Pteraxii Skystalkers', role:'Other', type:'Infantry',
    pts: 85, minModels:5, maxModels:10, ptsPerModel:17,
    M:'12"', T:4, Sv:'4+', W:1, Ld:'6+', OC:1, invul:'5+',
    keywords:['INFANTRY','FLY','JUMP PACK','SKITARII','DOCTRINA IMPERATIVES'],
    abilities:[
      {name:'Skystalker Strike', text:'In your Charge phase, if this unit charges, each model in this unit may shoot its ranged weapons before or after the charge move (once per phase).'},
    ],
    ranged:[
      {name:'Pteraxii talons (thrown)', range:'9"', a:2, bs:'3+', s:3, ap:0, d:1, keywords:'[ASSAULT]'},
      {name:'Flechette carbine', range:'18"', a:4, bs:'3+', s:3, ap:0, d:1, keywords:'[ASSAULT]'},
    ],
    weaponOptions:[
      {slot:'ranged1', label:'Ranged weapon', options:['Pteraxii talons (thrown)','Flechette carbine']}
    ],
    melee:[
      {name:'Pteraxii talons', a:4, ws:'3+', s:3, ap:0, d:1, keywords:''},
    ]
  },
  {
    id:'pteraxii_ster', name:'Pteraxii Sterylizors', role:'Other', type:'Infantry',
    pts: 75, minModels:5, maxModels:10, ptsPerModel:15,
    M:'12"', T:4, Sv:'4+', W:1, Ld:'6+', OC:1, invul:'5+',
    keywords:['INFANTRY','FLY','JUMP PACK','SKITARII','DOCTRINA IMPERATIVES'],
    abilities:[
      {name:'Incendiary Assault', text:'After this unit charges, roll D6 for each enemy model within 1" of any model in this unit. On a 5+, that model\'s unit suffers 1 mortal wound.'},
    ],
    ranged:[
      {name:'Phosphor torch', range:'12"', a:'D3+3', bs:'N/A', s:4, ap:'-1', d:1, keywords:'[TORRENT][LETHAL HITS]'},
    ],
    melee:[
      {name:'Pteraxii talons', a:4, ws:'3+', s:3, ap:0, d:1, keywords:''},
    ]
  },
  {
    id:'onager', name:'Onager Dunecrawler', role:'Other', type:'Vehicle',
    pts: 155,
    M:'8"', T:9, Sv:'2+', W:11, Ld:'6+', OC:3, invul:'5+',
    keywords:['VEHICLE','WALKER','CULT MECHANICUS','DOCTRINA IMPERATIVES'],
    abilities:[
      {name:'Broad Spectrum Data-tether', text:'Friendly ADEPTUS MECHANICUS units within 6" add 1 to their Objective Control characteristics.'},
      {name:'Emanatus Force Field (Aura)', text:'Friendly ADEPTUS MECHANICUS VEHICLE units within 6" have a 5+ invulnerable save.'},
    ],
    ranged:[
      {name:'Neutron laser & cognis heavy stubber', range:'48"', a:2, bs:'3+', s:14, ap:'-4', d:'D6+3', keywords:'[BLAST][HEAVY]'},
      {name:'Cognis heavy stubber', range:'36"', a:3, bs:'3+', s:4, ap:0, d:1, keywords:'[HEAVY]'},
      {name:'Eradication beamer', range:'18"', a:3, bs:'3+', s:8, ap:'-4', d:'D3+3', keywords:''},
      {name:'Icarus array', range:'48"', a:'4+D3', bs:'3+', s:7, ap:'-1', d:2, keywords:'[ANTI-FLY 2+]'},
    ],
    weaponOptions:[
      {slot:'ranged1', label:'Main armament', options:['Neutron laser & cognis heavy stubber','Eradication beamer','Icarus array']}
    ],
    melee:[
      {name:'Dunecrawler legs', a:3, ws:'4+', s:6, ap:0, d:1, keywords:''},
    ]
  },
  {
    id:'disintegrator', name:'Skorpius Disintegrator', role:'Other', type:'Vehicle',
    pts: 145,
    M:'10"', T:9, Sv:'3+', W:11, Ld:'6+', OC:3, invul:'5+',
    keywords:['VEHICLE','CULT MECHANICUS','SMOKE'],
    abilities:[
      {name:'Smoke', text:'Once per battle, in your Movement phase, this model can use Smoke. Until the start of your next turn, all models in attacking units targeting this model subtract 1 from Hit rolls.'},
      {name:'Disintegration Matrix', text:'Each time this model makes a ranged attack, if the target is in cover, the target does not benefit from that cover.'},
    ],
    ranged:[
      {name:'Belleros energy cannon', range:'36"', a:'D3+3', bs:'3+', s:9, ap:'-2', d:3, keywords:'[BLAST][IGNORES COVER]'},
      {name:'Disruptor missile launcher', range:'36"', a:3, bs:'3+', s:5, ap:'-1', d:2, keywords:'[INDIRECT FIRE]'},
      {name:'Cognis heavy stubber (×3)', range:'36"', a:9, bs:'3+', s:4, ap:0, d:1, keywords:''},
    ],
    weaponOptions:[
      {slot:'ranged1', label:'Main weapon', options:['Belleros energy cannon','Disruptor missile launcher']}
    ],
    melee:[
      {name:'Armoured hull', a:3, ws:'5+', s:6, ap:0, d:1, keywords:''},
    ]
  },
  {
    id:'dunerider', name:'Skorpius Dunerider', role:'Transport', type:'Vehicle',
    pts: 75,
    M:'10"', T:9, Sv:'3+', W:11, Ld:'6+', OC:3, invul:'5+',
    keywords:['VEHICLE','DEDICATED TRANSPORT','CULT MECHANICUS','SMOKE'],
    abilities:[
      {name:'Transport', text:'Capacity: 12 ADEPTUS MECHANICUS INFANTRY models (not JUMP PACK, KATAPHRON, or SYDONIAN SKATROS).'},
      {name:'Smoke', text:'Once per battle, use Smoke in Movement phase. Attackers subtract 1 from Hit rolls until start of your next turn.'},
    ],
    ranged:[
      {name:'Twin cognis heavy stubber', range:'36"', a:6, bs:'3+', s:4, ap:0, d:1, keywords:'[TWIN-LINKED]'},
    ],
    melee:[
      {name:'Armoured hull', a:3, ws:'5+', s:6, ap:0, d:1, keywords:''},
    ]
  },
  {
    id:'fusilave', name:'Archaeopter Fusilave', role:'Other', type:'Vehicle',
    pts: 115,
    M:'20"', T:8, Sv:'3+', W:10, Ld:'6+', OC:2, invul:'5+',
    keywords:['VEHICLE','FLY','AIRCRAFT','CULT MECHANICUS','DOCTRINA IMPERATIVES'],
    abilities:[
      {name:'Hard to Hit', text:'While this model is in the air, subtract 1 from Hit rolls of ranged attacks targeting this model.'},
      {name:'Bombing Run', text:'After this model moves, you can select one enemy unit it flew over and roll D6 for each model in that unit. On a 5+, that unit suffers 1 mortal wound.'},
    ],
    ranged:[
      {name:'Fusilave bombing array', range:'6"', a:'2D6', bs:'N/A', s:6, ap:'-1', d:2, keywords:'[TORRENT][IGNORES COVER]'},
      {name:'Cognis heavy stubber (pair)', range:'36"', a:6, bs:'3+', s:4, ap:0, d:1, keywords:''},
    ],
    melee:[
      {name:'Armoured hull', a:3, ws:'5+', s:6, ap:0, d:1, keywords:''},
    ]
  },
  {
    id:'stratoraptor', name:'Archaeopter Stratoraptor', role:'Other', type:'Vehicle',
    pts: 130,
    M:'20"', T:8, Sv:'3+', W:10, Ld:'6+', OC:2, invul:'5+',
    keywords:['VEHICLE','FLY','AIRCRAFT','CULT MECHANICUS','DOCTRINA IMPERATIVES'],
    abilities:[
      {name:'Hard to Hit', text:'Subtract 1 from Hit rolls of ranged attacks targeting this model while in the air.'},
      {name:'Air Superiority', text:'Ranged attacks made by this model against AIRCRAFT units do not suffer the -1 BS penalty.'},
    ],
    ranged:[
      {name:'Twin heavy phosphor blaster', range:'24"', a:8, bs:'3+', s:6, ap:'-1', d:2, keywords:'[TWIN-LINKED][LETHAL HITS]'},
      {name:'Cognis lascannon', range:'48"', a:1, bs:'3+', s:12, ap:'-3', d:'D6+1', keywords:''},
    ],
    melee:[
      {name:'Armoured hull', a:3, ws:'5+', s:6, ap:0, d:1, keywords:''},
    ]
  },
  {
    id:'transvector', name:'Archaeopter Transvector', role:'Other', type:'Vehicle',
    pts: 110,
    M:'20"', T:8, Sv:'3+', W:10, Ld:'6+', OC:2, invul:'5+',
    keywords:['VEHICLE','FLY','AIRCRAFT','DEDICATED TRANSPORT','CULT MECHANICUS'],
    abilities:[
      {name:'Transport', text:'Capacity: 6 ADEPTUS MECHANICUS INFANTRY models (not JUMP PACK, KATAPHRON, or VEHICLE models). Fly on/off board each turn.'},
      {name:'Hard to Hit', text:'Subtract 1 from Hit rolls of ranged attacks targeting this model while in the air.'},
    ],
    ranged:[
      {name:'Twin cognis heavy stubber', range:'36"', a:6, bs:'3+', s:4, ap:0, d:1, keywords:'[TWIN-LINKED]'},
    ],
    melee:[
      {name:'Armoured hull', a:3, ws:'5+', s:6, ap:0, d:1, keywords:''},
    ]
  },
  {
    id:'servitors', name:'Servitor Battleclade', role:'Other', type:'Infantry',
    pts: 40, minModels:4, maxModels:4, ptsPerModel:10,
    M:'5"', T:4, Sv:'4+', W:1, Ld:'8+', OC:1, invul:null,
    keywords:['INFANTRY','CULT MECHANICUS'],
    abilities:[
      {name:'Mindless', text:'This unit automatically passes Morale tests. Battle-shock tests are auto-failed (however, this is rarely relevant).'},
    ],
    ranged:[
      {name:'Plasma cannon (standard)', range:'36"', a:2, bs:'4+', s:7, ap:'-2', d:1, keywords:'[BLAST]'},
      {name:'Plasma cannon (supercharge)', range:'36"', a:2, bs:'4+', s:8, ap:'-3', d:2, keywords:'[BLAST][HAZARDOUS]'},
      {name:'Multi-melta', range:'18"', a:2, bs:'4+', s:9, ap:'-4', d:'D6', keywords:'[MELTA 2]'},
    ],
    weaponOptions:[
      {slot:'ranged1', label:'Heavy servitor weapon', options:['Plasma cannon (standard)','Plasma cannon (supercharge)','Multi-melta']}
    ],
    melee:[
      {name:'Servo-arm', a:2, ws:'4+', s:8, ap:'-2', d:3, keywords:''},
    ]
  },
];

// ============================
// LEADER-BODYGUARD MAP
// ============================
const LEADER_MAP = {
  cawl: [], // Epic Hero — no attach
  datasmith: ['robots'],
  marshal: ['rangers','vanguard','infiltrators','ruststalkers','pteraxii_sky','pteraxii_ster','serberys_raiders','serberys_sulph'],
  dominus: ['rangers','vanguard','fulgurites','corpuscarii','breachers','destroyers'],
  enginseer: ['servitors'],
  manipulus: ['rangers','vanguard','fulgurites','corpuscarii'],
  technoarcheologist: ['rangers','vanguard'],
  skatros: [], // Lone Operative
};

// ============================
// STATE
// ============================
let roster = []; // {unitId, count, selectedWeapons, attachedLeaderId, id}
let activeDetachment = 'skitarii';
let nextId = 1;

// ============================
// INIT
// ============================
document.addEventListener('DOMContentLoaded', () => {
  renderDetachments();
  setDetachment('skitarii');
  renderModalGrid();
});

// ============================
// DETACHMENTS
// ============================
function renderDetachments() {
  const list = document.getElementById('det-list');
  list.innerHTML = DETACHMENTS.map(d => `
    <div class="det-btn ${d.id===activeDetachment?'active':''}" onclick="setDetachment('${d.id}')" id="det-${d.id}">
      <div class="det-name">${d.name}</div>
      <div class="det-desc">${d.short}</div>
    </div>
  `).join('');
}

function setDetachment(id) {
  activeDetachment = id;
  document.querySelectorAll('.det-btn').forEach(b => b.classList.remove('active'));
  const btn = document.getElementById('det-'+id);
  if(btn) btn.classList.add('active');
  const det = DETACHMENTS.find(d=>d.id===id);
  document.getElementById('det-rule-title').textContent = det.ruleName;
  document.getElementById('det-rule-text').textContent = det.ruleText;
}

// ============================
// IMPERATIVES
// ============================
const IMPERATIVES = {
  pro: { tabs: ['tab-pro','tab-con'], content: '<ul><li>Ranged weapons gain [HEAVY]</li><li>+1 to BS of all ranged weapons</li><li>Subtract 1 from hit rolls of melee attacks vs BATTLELINE or units within 6" of BATTLELINE</li></ul>' },
  con: { tabs: ['tab-con','tab-pro'], content: '<ul><li>Ranged weapons gain [ASSAULT]</li><li>+1 to WS of all melee weapons</li><li>+1 AP to all attacks for BATTLELINE or units within 6" of BATTLELINE</li></ul>' }
};

function showImperative(type) {
  document.getElementById('imperative-text').innerHTML = IMPERATIVES[type].content;
  document.getElementById('tab-pro').className = 'imp-tab' + (type==='pro'?' active-pro':'');
  document.getElementById('tab-con').className = 'imp-tab' + (type==='con'?' active-con':'');
}

function setDocBanner(type) {
  document.getElementById('doc-pro').className = 'doc-btn' + (type==='pro'?' active-pro':'');
  document.getElementById('doc-con').className = 'doc-btn' + (type==='con'?' active-con':'');
}

// ============================
// MODAL
// ============================
function openModal() {
  document.getElementById('modal').classList.add('open');
  renderModalGrid();
}
function closeModal() {
  document.getElementById('modal').classList.remove('open');
}
document.getElementById('modal').addEventListener('click', e => {
  if(e.target === document.getElementById('modal')) closeModal();
});

function renderModalGrid(filter='') {
  const grid = document.getElementById('modal-grid');
  const cats = ['Character','Battleline','Transport','Other'];
  let html = '';
  cats.forEach(cat => {
    const units = UNITS.filter(u => u.role === cat && (!filter || u.name.toLowerCase().includes(filter.toLowerCase())));
    if(units.length === 0) return;
    html += `<div class="modal-cat-header">${cat}</div>`;
    units.forEach(u => {
      html += `<div class="modal-unit-btn" onclick="addUnit('${u.id}')">
        <div class="mu-name">${u.name}</div>
        <div class="mu-type">${u.type}</div>
        <div class="mu-pts">${u.pts} pts${u.minModels ? ` (${u.minModels} models)` : ''}</div>
      </div>`;
    });
  });
  if(!html) html = '<div style="grid-column:1/-1;text-align:center;color:var(--text-dim);padding:20px;font-family:var(--font-mono);font-size:11px;">No units found. Search the databank again.</div>';
  grid.innerHTML = html;
}

function filterUnits() {
  const val = document.getElementById('unit-search').value;
  renderModalGrid(val);
}

// ============================
// ROSTER MANAGEMENT
// ============================
function addUnit(unitId) {
  const unit = UNITS.find(u=>u.id===unitId);
  if(!unit) return;
  const entry = {
    id: nextId++,
    unitId,
    count: unit.minModels || 1,
    selectedWeapons: {},
    attachedLeaderId: null,
    expanded: false
  };
  // Default weapon selections
  if(unit.weaponOptions) unit.weaponOptions.forEach(opt => { entry.selectedWeapons[opt.slot] = opt.options[0]; });
  if(unit.weaponOptionsM) unit.weaponOptionsM.forEach(opt => { entry.selectedWeapons[opt.slot] = opt.options[0]; });
  roster.push(entry);
  closeModal();
  renderRoster();
  updatePoints();
}

function removeUnit(entryId) {
  roster = roster.filter(e => e.id !== entryId);
  // Remove any leaders attached to this unit
  roster.forEach(e => { if(e.attachedLeaderId === entryId) e.attachedLeaderId = null; });
  renderRoster();
  updatePoints();
}

function changeCount(entryId, delta) {
  const entry = roster.find(e=>e.id===entryId);
  const unit = UNITS.find(u=>u.id===entry.unitId);
  const min = unit.minModels || 1;
  const max = unit.maxModels || 1;
  entry.count = Math.max(min, Math.min(max, entry.count + delta));
  renderRoster();
  updatePoints();
}

function toggleExpand(entryId) {
  const entry = roster.find(e=>e.id===entryId);
  entry.expanded = !entry.expanded;
  const card = document.getElementById('card-'+entryId);
  card.classList.toggle('expanded', entry.expanded);
}

function updateWeapon(entryId, slot, value) {
  const entry = roster.find(e=>e.id===entryId);
  entry.selectedWeapons[slot] = value;
}

function attachLeader(entryId, leaderId) {
  const entry = roster.find(e=>e.id===entryId);
  // Remove this entry from any previous leader attachments
  roster.forEach(e => { if(e.attachedLeaderId === entryId) e.attachedLeaderId = null; });
  entry.attachedLeaderId = leaderId ? parseInt(leaderId) : null;
  renderRoster();
}

function calcEntryPts(entry) {
  const unit = UNITS.find(u=>u.id===entry.unitId);
  let pts = 0;
  if(unit.ptsPerModel) {
    pts = entry.count * unit.ptsPerModel;
  } else {
    pts = unit.pts;
  }
  // Add leader pts if attached
  if(entry.attachedLeaderId) {
    const leaderEntry = roster.find(e=>e.id===entry.attachedLeaderId);
    if(leaderEntry) {
      const leaderUnit = UNITS.find(u=>u.id===leaderEntry.unitId);
      pts += leaderUnit.pts;
    }
  }
  return pts;
}

function updatePoints() {
  let total = 0;
  // Count each roster entry (leaders counted separately unless attached)
  roster.forEach(entry => {
    const unit = UNITS.find(u=>u.id===entry.unitId);
    // Skip if this is a leader attached to another unit (already counted)
    const isAttachedLeader = roster.some(e => e.attachedLeaderId === entry.id);
    if(!isAttachedLeader) {
      if(unit.ptsPerModel) total += entry.count * unit.ptsPerModel;
      else total += unit.pts;
    }
  });
  document.getElementById('total-pts').textContent = total;
  // Color warning
  const el = document.getElementById('total-pts');
  if(total > 2000) el.style.color = '#e74c3c';
  else if(total > 1800) el.style.color = '#e67e22';
  else el.style.color = 'var(--machine-green)';
}

// ============================
// RENDER ROSTER
// ============================
function renderRoster() {
  const listEl = document.getElementById('roster-list');
  const emptyEl = document.getElementById('empty-state');

  if(roster.length === 0) {
    emptyEl.style.display = 'block';
    listEl.innerHTML = '';
    return;
  }
  emptyEl.style.display = 'none';

  // Group by role
  const byRole = {};
  roster.forEach(entry => {
    const unit = UNITS.find(u=>u.id===entry.unitId);
    if(!byRole[unit.role]) byRole[unit.role] = [];
    byRole[unit.role].push(entry);
  });

  const roleOrder = ['Character','Battleline','Transport','Other'];
  let html = '';

  roleOrder.forEach(role => {
    if(!byRole[role]) return;
    html += `<div class="unit-category">
      <div class="cat-label">${role}</div>`;

    byRole[role].forEach(entry => {
      const unit = UNITS.find(u=>u.id===entry.unitId);
      const pts = unit.ptsPerModel ? entry.count * unit.ptsPerModel : unit.pts;
      const min = unit.minModels || 1;
      const max = unit.maxModels || 1;
      const hasMultiSize = max > 1;

      // Leader options for this unit
      const leaderOptions = getAvailableLeaders(entry);
      const attachedLeader = entry.attachedLeaderId ? roster.find(e=>e.id===entry.attachedLeaderId) : null;
      const attachedLeaderUnit = attachedLeader ? UNITS.find(u=>u.id===attachedLeader.unitId) : null;

      html += `<div class="unit-card ${entry.expanded?'expanded':''}" id="card-${entry.id}">
        <div class="unit-card-header" onclick="toggleExpand(${entry.id})">
          <div class="unit-expand-btn">▶</div>
          <div class="unit-name">${unit.name}</div>
          ${hasMultiSize ? `<div class="unit-count-ctrl" onclick="event.stopPropagation()">
            <div class="count-btn" onclick="changeCount(${entry.id},-${unit.minModels||1})">−</div>
            <div class="count-val">${entry.count}</div>
            <div class="count-btn" onclick="changeCount(${entry.id},${unit.minModels||1})">+</div>
          </div>` : ''}
          <div class="unit-pts-badge">${pts} pts</div>
          <div class="remove-btn" onclick="event.stopPropagation(); removeUnit(${entry.id})">✕</div>
        </div>
        <div class="unit-details">
          <!-- Stats -->
          <div class="section-divider">Stats</div>
          <div class="stats-bar">
            <div class="stat-cell"><div class="stat-lbl">M</div><div class="stat-val">${unit.M}</div></div>
            <div class="stat-cell"><div class="stat-lbl">T</div><div class="stat-val">${unit.T}</div></div>
            <div class="stat-cell"><div class="stat-lbl">Sv</div><div class="stat-val">${unit.Sv}</div></div>
            <div class="stat-cell"><div class="stat-lbl">W</div><div class="stat-val">${unit.W}</div></div>
            <div class="stat-cell"><div class="stat-lbl">Ld</div><div class="stat-val">${unit.Ld}</div></div>
            <div class="stat-cell"><div class="stat-lbl">OC</div><div class="stat-val">${unit.OC}</div></div>
            ${unit.invul ? `<div class="stat-cell invul"><div class="stat-lbl">Inv.</div><div class="stat-val">${unit.invul}</div></div>` : ''}
          </div>

          ${renderWeaponOptions(entry, unit)}

          ${unit.ranged.length > 0 ? `
          <div class="section-divider">Ranged Weapons</div>
          <table class="weapon-table">
            <thead><tr>
              <th>Weapon</th><th>Range</th><th>A</th><th>BS</th><th>S</th><th>AP</th><th>D</th><th>Abilities</th>
            </tr></thead>
            <tbody>${renderWeaponRows(entry, unit, 'ranged')}</tbody>
          </table>` : ''}

          ${unit.melee.length > 0 ? `
          <div class="section-divider">Melee Weapons</div>
          <table class="weapon-table">
            <thead><tr>
              <th>Weapon</th><th>Range</th><th>A</th><th>WS</th><th>S</th><th>AP</th><th>D</th><th>Abilities</th>
            </tr></thead>
            <tbody>${renderWeaponRows(entry, unit, 'melee')}</tbody>
          </table>` : ''}

          ${unit.abilities.length > 0 ? `
          <div class="section-divider">Abilities</div>
          <div class="abilities-section">
            ${unit.abilities.map(a=>`<div class="ability-item">
              <div class="ability-name">◈ ${a.name}</div>
              <div class="ability-text">${a.text}</div>
            </div>`).join('')}
          </div>` : ''}

          ${leaderOptions.length > 0 && unit.role !== 'Character' ? `
          <div class="section-divider">Attach Leader</div>
          <div class="leader-attach-section">
            <select class="leader-select" onchange="attachLeader(${entry.id}, this.value)">
              <option value="">— None —</option>
              ${leaderOptions.map(l=>`<option value="${l.entryId}" ${entry.attachedLeaderId===l.entryId?'selected':''}>${l.name} (${l.pts} pts)</option>`).join('')}
            </select>
            ${attachedLeaderUnit ? `<div class="attached-leader-badge">⚙ ${attachedLeaderUnit.name} attached</div>` : ''}
          </div>` : ''}

          <div class="keyword-list">
            ${unit.keywords.map(k=>`<span class="kw-badge">${k}</span>`).join('')}
          </div>
        </div>
      </div>`;
    });

    html += `</div>`;
  });

  listEl.innerHTML = html;
}

function renderWeaponOptions(entry, unit) {
  const allOpts = [...(unit.weaponOptions||[]), ...(unit.weaponOptionsM||[])];
  if(allOpts.length === 0) return '';
  return `<div class="section-divider">Weapon Loadout</div>
    ${allOpts.map(opt => `
    <div class="weapon-opt-row">
      <div class="weapon-opt-label">${opt.label}:</div>
      <select class="weapon-opt-select" onchange="updateWeapon(${entry.id},'${opt.slot}',this.value)">
        ${opt.options.map(o=>`<option value="${o}" ${entry.selectedWeapons[opt.slot]===o?'selected':''}>${o}</option>`).join('')}
      </select>
    </div>`).join('')}`;
}

function renderWeaponRows(entry, unit, type) {
  const weapons = type === 'ranged' ? unit.ranged : unit.melee;
  // Filter by selected options if applicable
  const selected = Object.values(entry.selectedWeapons);
  return weapons
    .filter(w => {
      // Show weapon if no options defined, or if it matches a selected option
      const allOpts = [...(unit.weaponOptions||[]), ...(unit.weaponOptionsM||[])].flatMap(o=>o.options);
      if(allOpts.length === 0) return true;
      // If this weapon name matches any option, only show if selected
      const isOptional = allOpts.some(o => o.includes(w.name) || w.name.includes(o.split(' (')[0]));
      if(!isOptional) return true;
      return selected.some(s => s === w.name || w.name.includes(s.split(' (')[0]) || s.includes(w.name));
    })
    .map(w => `<tr>
      <td><span class="weapon-name">${w.name}</span> <span class="w-type-badge ${type==='ranged'?'w-ranged':'w-melee'}">${type==='ranged'?'RNG':'MEL'}</span></td>
      <td>${type==='ranged'?w.range:'Melee'}</td>
      <td>${w.a}</td>
      <td style="color:var(--machine-green)">${type==='ranged'?w.bs:w.ws}</td>
      <td>${w.s}</td>
      <td>${w.ap}</td>
      <td>${w.d}</td>
      <td><span class="w-keywords">${w.keywords||'-'}</span></td>
    </tr>`).join('');
}

function getAvailableLeaders(bodyguardEntry) {
  const bodyUnit = UNITS.find(u=>u.id===bodyguardEntry.unitId);
  return roster
    .filter(e => {
      if(e.id === bodyguardEntry.id) return false;
      const u = UNITS.find(x=>x.id===e.unitId);
      if(!u.isLeader) return false;
      if(u.noAttach) return false; // Epic Hero standalone
      // Check if this leader can lead this bodyguard unit type
      const canLeadList = LEADER_MAP[u.id] || [];
      return canLeadList.includes(bodyUnit.id);
    })
    .map(e => {
      const u = UNITS.find(x=>x.id===e.unitId);
      return { entryId: e.id, name: u.name, pts: u.pts };
    });
}
</script>
</body>
</html>
